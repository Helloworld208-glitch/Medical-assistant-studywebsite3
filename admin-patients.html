<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedAssist - Patient Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
        }

        [data-bs-theme="dark"] {
            --background: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Professional Navigation */
        .navbar {
            height: 64px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .sidebar {
            width: 240px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            height: 100vh;
            z-index: 1030;
        }

        .nav-link {
            color: var(--text-secondary);
            padding: 12px 20px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-link.active {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            font-weight: 500;
        }

        /* Settings Dropdown */
        .settings-nav {
            position: relative;
        }

        .settings-dropdown {
            display: none;
            position: absolute;
            left: 0;
            top: 100%;
            width: 100%;
            padding: 8px 0;
            margin-top: 4px;
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .settings-dropdown a {
            display: block;
            padding: 8px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }

        .settings-dropdown a:hover {
            background-color: rgba(37, 99, 235, 0.05);
            color: var(--primary);
        }
        
        .settings-dropdown a i {
            margin-right: 8px;
        }

        .show-dropdown {
            display: block;
        }
        
        /* Rotating chevron */
        .chevron-icon {
            transition: transform 0.3s ease;
            display: inline-block;
        }
        
        .rotate-chevron {
            transform: rotate(180deg);
        }

        /* Patient card styles */
        .patient-card {
            background-color: rgb(39,38,46);
            border-radius: 15px;
            overflow: hidden;
            transition: transform 0.2s;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 100%;
        }

        .patient-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .patient-card .card-body {
            padding: 1.5rem;
        }

        .patient-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: 0.35rem;
        }

        /* Search bar */
        .search-bar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
        }

        .search-bar:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Pagination */
        .page-link {
            color: var(--primary);
            background-color: var(--surface);
            border: 1px solid var(--border);
        }

        .page-link:hover {
            background-color: rgba(37, 99, 235, 0.05);
            border-color: var(--border);
        }

        .page-item.active .page-link {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        /* Auth warning */
        .auth-warning {
            padding: 16px;
            border-radius: 8px;
            background-color: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            margin-bottom: 24px;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner-container {
            background-color: var(--surface);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .spinner-container p {
            margin-top: 1rem;
            color: var(--text-secondary);
        }

        /* Patient detail cards */
        .detail-card {
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: rgba(37, 99, 235, 0.05);
            border-left: 3px solid var(--primary);
        }

        /* Patient actions */
        .patient-actions {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
        }

        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
        }

        /* Toggle sidebar button */
        #sidebarToggle {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1060;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Sidebar backdrop */
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1020;
        }
        
        /* Main content */
        .main-content {
            transition: margin-left 0.3s ease;
        }
        
        /* Responsive styles */
        @media (max-width: 991.98px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 0 0 15px rgba(0,0,0,0.1);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .sidebar-backdrop.show {
                display: block;
            }
            
            #sidebarToggle {
                display: block;
            }
            
            .main-content {
                margin-left: 0 !important;
                padding: 20px !important;
                padding-top: 48px !important;
            }
            
            .patient-card .card-title {
                font-size: 1.1rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .patient-card .card-text {
                font-size: 0.85rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }
        
        @media (max-width: 767.98px) {
            .search-filter-row {
                flex-direction: column;
            }
            
            .search-filter-row > div {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .patient-count-container {
                text-align: left !important;
                margin-top: 10px;
            }
            
            .detail-card {
                padding: 10px;
            }
        }
        
        @media (max-width: 575.98px) {
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .patient-badge {
                font-size: 0.65em;
            }
            
            .notification-badge {
                font-size: 0.6rem;
                padding: 0.2rem 0.4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar toggle button for mobile -->
    <button id="sidebarToggle" class="btn" type="button">
        <i class="bi bi-list fs-5"></i>
    </button>

    <!-- Backdrop for mobile sidebar -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    
    <div class="d-flex">
        <!-- Sidebar -->
        <nav class="sidebar vh-100 position-fixed" id="sidebar">
            <div class="p-4">
                <div class="mb-5">
                    <h3 class="text-primary fw-bold">MedAssist</h3>
                    <p class="text-secondary small">Admin Panel</p>
                </div>
                
                <nav class="nav flex-column gap-2">
                    <a class="nav-link" href="admindashboard.html">
                        <i class="bi bi-speedometer2 me-2"></i>
                        Dashboard
                    </a>
                    <a class="nav-link active" href="#">
                        <i class="bi bi-people-fill me-2"></i>
                        Patients
                    </a>
                    <a class="nav-link" href="admin-appointments.html">
                        <i class="bi bi-calendar2-week me-2"></i>
                        Appointments
                    </a>
                    <a class="nav-link" href="admin-chat.html">
                        <i class="bi bi-chat-dots me-2"></i>
                        Support Chat
                    </a>
                    <a class="nav-link" href="admin-analysis.html">
                        <i class="bi bi-file-earmark-medical me-2"></i>
                        Analysis Upload
                    </a>
                    <div class="settings-nav">
                        <a class="nav-link" href="#" id="settingsLink">
                            <i class="bi bi-gear me-2"></i>
                            Settings
                            <i class="bi bi-chevron-down float-end mt-1 chevron-icon" id="settingsChevron"></i>
                        </a>
                        <div class="settings-dropdown" id="settingsDropdown">
                            <a href="javascript:void(0);" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i>
                                Log Out
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content flex-grow-1" id="mainContent" style="margin-left: 240px; padding: 32px;">
            <!-- Auth Warning (will show only if not logged in) -->
            <div id="authWarning" class="auth-warning" style="display: none;">
                <div class="d-flex align-items-center flex-wrap">
                    <i class="bi bi-exclamation-triangle-fill text-warning fs-4 me-3"></i>
                    <div>
                        <h6 class="mb-1">Please Log In</h6>
                        <p class="mb-0">You need to be logged in as an administrator to view this page.</p>
                    </div>
                    <a href="adminlogin.html" class="btn btn-warning ms-auto mt-2 mt-md-0">Log In</a>
                </div>
            </div>

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                <div class="mb-2 mb-sm-0">
                    <h2 class="h4 fw-semibold mb-1">Patient Management</h2>
                    <p class="text-secondary mb-0">View and manage registered patients</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshPatients()">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>

            <!-- Search and Filter Bar -->
            <div class="mb-4">
                <div class="row g-3 align-items-center search-filter-row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" id="searchInput" class="form-control search-bar" 
                                placeholder="Search patients by name or email" 
                                oninput="filterPatients()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select search-bar" id="sortSelect" onchange="sortPatients()">
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="id-asc">ID (Ascending)</option>
                            <option value="id-desc">ID (Descending)</option>
                        </select>
                    </div>
                    <div class="col-md-3 text-md-end patient-count-container">
                        <span class="text-secondary" id="patientCount">
                            <i class="bi bi-people-fill me-1"></i>
                            <span id="totalPatients">0</span> patients
                        </span>
                    </div>
                </div>
            </div>

            <!-- Patients Grid -->
            <div class="row g-4" id="patientsContainer">
                <!-- Loading placeholder -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-secondary">Loading patients...</p>
                </div>
            </div>

            <!-- Pagination -->
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Pagination will be generated dynamically -->
                </ul>
            </nav>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading patient data...</p>
        </div>
    </div>

    <!-- View Patient Modal -->
    <div class="modal fade" id="viewPatientModal" tabindex="-1" aria-labelledby="viewPatientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewPatientModalLabel">Patient Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="patientDetails">
                    <!-- Patient details will be loaded here -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-secondary">Loading patient details...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="viewAppointmentsBtn">View Appointments</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let allPatients = [];
        let currentPage = 1;
        const patientsPerPage = 12;
        let viewPatientModal;
        
        /**
         * Logout Function
         * Removes JWT token and redirects to login page
         */
        function logout() {
            // Remove JWT token from localStorage
            localStorage.removeItem('jwtToken');
            
            // Redirect to adminlogin.html page
            window.location.href = 'adminlogin.html';
        }
        
        /**
         * Checks if JWT token exists, redirects to login page if not
         */
        function checkTokenAndRedirect() {
            // Check if token exists in localStorage
            if (!localStorage.getItem('jwtToken')) {
                // No token found, redirect to adminlogin page
                window.location.href = 'adminlogin.html';
            }
        }
        
        // Check authentication and show/hide warning
        function checkAuthentication() {
            const token = localStorage.getItem('jwtToken');
            const authWarning = document.getElementById('authWarning');
            
            if (!token) {
                authWarning.style.display = 'block';
                return false;
            } else {
                authWarning.style.display = 'none';
                return true;
            }
        }

        // Load patients from the API
        async function loadPatients() {
            if (!checkAuthentication()) return;
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await axios.post(
                    "https://mystudyproject-ecdrcgbmdufrbhbj.francecentral-01.azurewebsites.net/auth/getaadminpatiens",
                    {},
                    { headers: { authorization: `Bearer ${token}` } }
                );
                
                allPatients = response.data;
                document.getElementById('totalPatients').textContent = allPatients.length;
                
                // Initialize display
                displayPatients(allPatients, currentPage);
                setupPagination(allPatients.length);
                
            } catch (error) {
                console.error('Error loading patients:', error);
                document.getElementById('patientsContainer').innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                        <h4 class="mt-3">Error Loading Patients</h4>
                        <p class="text-secondary">An error occurred while loading patient data. Please try again.</p>
                        <button class="btn btn-primary mt-2" onclick="refreshPatients()">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Retry
                        </button>
                    </div>
                `;
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // Display patients with pagination
        function displayPatients(patients, page) {
            const container = document.getElementById('patientsContainer');
            container.innerHTML = '';
            
            // Calculate start and end indices
            const startIndex = (page - 1) * patientsPerPage;
            const endIndex = Math.min(startIndex + patientsPerPage, patients.length);
            
            // Check if there are patients to display
            if (patients.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-people text-secondary fs-1"></i>
                        <h4 class="mt-3">No Patients Found</h4>
                        <p class="text-secondary">There are no patients matching your criteria.</p>
                    </div>
                `;
                return;
            }
            
            // Create patient cards
            const currentPatients = patients.slice(startIndex, endIndex);
            currentPatients.forEach(patient => {
                // Generate a random number of pending appointments for demo purposes (1-3)
                const pendingAppointments = Math.floor(Math.random() * 3) + 1;
                
                const patientCard = document.createElement('div');
                patientCard.className = 'col-sm-6 col-md-6 col-lg-4 col-xl-3';
                patientCard.innerHTML = `
                    <div class="patient-card position-relative" onclick="viewPatientDetails(${patient.id})">
                        <div class="card-body text-white">
                            <span class="patient-badge bg-primary">ID: ${patient.id}</span>
                            <h5 class="card-title">${patient.firstname} ${patient.lasttname}</h5>
                            <p class="card-text mb-1">
                                <i class="bi bi-envelope-fill me-2"></i>
                                ${patient.email}
                            </p>
                            <div class="position-relative d-inline-block mt-3">
                                <button class="btn btn-sm btn-outline-light">
                                    <i class="bi bi-calendar-check me-1"></i> 
                                    Appointments
                                </button>
                                <span class="badge rounded-pill bg-danger notification-badge">${pendingAppointments}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(patientCard);
            });
        }

        // Setup pagination
        function setupPagination(totalPatients) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            const totalPages = Math.ceil(totalPatients / patientsPerPage);
            
            // Only show pagination if there's more than one page
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Previous" onclick="changePage(${currentPage - 1}); return false;">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
            pagination.appendChild(prevLi);
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
                `;
                pagination.appendChild(firstLi);
                
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<a class="page-link" href="#">...</a>`;
                    pagination.appendChild(ellipsisLi);
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                `;
                pagination.appendChild(pageLi);
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<a class="page-link" href="#">...</a>`;
                    pagination.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
                `;
                pagination.appendChild(lastLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Next" onclick="changePage(${currentPage + 1}); return false;">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
            pagination.appendChild(nextLi);
        }

        // Change page
        function changePage(page) {
            const filteredPatients = filterAndSortPatients();
            const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
            
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayPatients(filteredPatients, currentPage);
            setupPagination(filteredPatients.length);
            
            // Scroll to top of the container
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Filter patients based on search input
        function filterPatients() {
            const filteredPatients = filterAndSortPatients();
            currentPage = 1; // Reset to first page on filter
            displayPatients(filteredPatients, currentPage);
            setupPagination(filteredPatients.length);
        }

        // Sort patients based on selected option
        function sortPatients() {
            const filteredPatients = filterAndSortPatients();
            displayPatients(filteredPatients, currentPage);
        }

        // Combined filter and sort function
        function filterAndSortPatients() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sortOption = document.getElementById('sortSelect').value;
            
            // Filter
            let filteredPatients = allPatients.filter(patient => {
                const fullName = `${patient.firstname} ${patient.lasttname}`.toLowerCase();
                const email = patient.email.toLowerCase();
                return fullName.includes(searchTerm) || email.includes(searchTerm) || 
                       patient.id.toString().includes(searchTerm);
            });
            
            // Sort
            filteredPatients.sort((a, b) => {
                switch (sortOption) {
                    case 'name-asc':
                        return `${a.firstname} ${a.lasttname}`.localeCompare(`${b.firstname} ${b.lasttname}`);
                    case 'name-desc':
                        return `${b.firstname} ${b.lasttname}`.localeCompare(`${a.firstname} ${a.lasttname}`);
                    case 'id-asc':
                        return a.id - b.id;
                    case 'id-desc':
                        return b.id - a.id;
                    default:
                        return 0;
                }
            });
            
            return filteredPatients;
        }

        // View patient details
        async function viewPatientDetails(patientId) {
            const patient = allPatients.find(p => p.id === patientId);
            if (!patient) return;
            
            // Initialize the modal if not already done
            if (!viewPatientModal) {
                viewPatientModal = new bootstrap.Modal(document.getElementById('viewPatientModal'));
            }
            
            // Show the modal
            viewPatientModal.show();
            
            const modalBody = document.getElementById('patientDetails');
            
            // For demo purposes, simulate loading patient appointments
            try {
                modalBody.innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading patient details...</span>
                        </div>
                        <p class="mt-2">Loading patient information...</p>
                    </div>
                `;

                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const currentDate = new Date('2025-05-15').toISOString().split('T')[0]; // Using the date provided
                
                // Sample appointment data for this patient
                const appointments = [
                    { date: currentDate, status: 'pending', reason: 'Regular checkup' },
                    { date: '2025-05-22', status: 'approved', reason: 'Follow-up' },
                    { date: '2025-05-02', status: 'rejected', reason: 'Consultation' },
                ];
                
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3">Personal Information</h5>
                            <div class="detail-card">
                                <p class="mb-1"><strong>ID:</strong> ${patient.id}</p>
                                <p class="mb-1"><strong>Name:</strong> ${patient.firstname} ${patient.lasttname}</p>
                                <p class="mb-0"><strong>Email:</strong> ${patient.email}</p>
                            </div>
                            
                            <h5 class="border-bottom pb-2 mb-3 mt-4">Account Status</h5>
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-success me-2">Active</span>
                                <span class="text-secondary">Account created on May 10, 2025</span>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3">Recent Appointments</h5>
                            
                            ${appointments.map(appt => `
                                <div class="detail-card ${
                                    appt.status === 'pending' ? 'border-warning' : 
                                    appt.status === 'approved' ? 'border-success' : 'border-danger'
                                }" style="border-left-color: ${
                                    appt.status === 'pending' ? 'var(--warning)' : 
                                    appt.status === 'approved' ? 'var(--success)' : 'var(--danger)'
                                }">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="mb-1"><strong>Date:</strong> ${appt.date}</p>
                                            <p class="mb-1"><strong>Reason:</strong> ${appt.reason}</p>
                                        </div>
                                        <span class="badge ${
                                            appt.status === 'pending' ? 'bg-warning text-dark' : 
                                            appt.status === 'approved' ? 'bg-success' : 'bg-danger'
                                        }">
                                            ${appt.status.charAt(0).toUpperCase() + appt.status.slice(1)}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${appointments.length === 0 ? `
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="bi bi-calendar-x text-secondary fs-3"></i>
                                    <p class="mt-2">No appointments found</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">Notes</h5>
                            <textarea class="form-control" rows="3" placeholder="Add notes about this patient..."></textarea>
                            <div class="d-flex justify-content-end mt-2">
                                <button class="btn btn-sm btn-outline-primary">Save Notes</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Set up the View Appointments button
                document.getElementById('viewAppointmentsBtn').addEventListener('click', function() {
                    viewPatientAppointments(patientId);
                });
                
            } catch (error) {
                console.error('Error loading patient details:', error);
                modalBody.innerHTML = `
                    <div class="text-center py-3">
                        <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                        <p class="mt-2">Failed to load patient details. Please try again.</p>
                    </div>
                `;
            }
        }

        // View patient appointments
        function viewPatientAppointments(patientId) {
            console.log(`View appointments for patient ${patientId}`);
            if (viewPatientModal) {
                viewPatientModal.hide();
            }
            // In a real implementation, you might redirect to appointments page filtered for this patient
            // window.location.href = `admin-appointments.html?patientId=${patientId}`;
        }

        // Refresh patients
        function refreshPatients() {
            currentPage = 1;
            loadPatients();
        }
        
        // Toggle sidebar function for mobile view
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            sidebar.classList.toggle('show');
            backdrop.classList.toggle('show');
        }

        // Settings dropdown toggle with improved mobile handling
        function setupSettingsDropdown() {
            const settingsLink = document.getElementById('settingsLink');
            const settingsDropdown = document.getElementById('settingsDropdown');
            const settingsChevron = document.getElementById('settingsChevron');
            
            function toggleSettingsDropdown(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Toggle dropdown visibility
                settingsDropdown.classList.toggle('show-dropdown');
                
                // Toggle chevron rotation
                settingsChevron.classList.toggle('rotate-chevron');
            }
            
            // Add event listeners for mobile support
            settingsLink.addEventListener('click', toggleSettingsDropdown);
            settingsLink.addEventListener('touchend', function(e) {
                e.preventDefault();
                toggleSettingsDropdown(e);
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!settingsLink.contains(event.target) && !settingsDropdown.contains(event.target)) {
                    settingsDropdown.classList.remove('show-dropdown');
                    settingsChevron.classList.remove('rotate-chevron');
                }
            });
            
            document.addEventListener('touchend', function(event) {
                if (!settingsLink.contains(event.target) && !settingsDropdown.contains(event.target)) {
                    settingsDropdown.classList.remove('show-dropdown');
                    settingsChevron.classList.remove('rotate-chevron');
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check token and redirect if not found
            checkTokenAndRedirect();
            
            // Initialize settings dropdown
            setupSettingsDropdown();
            
            // Set main content display for responsive behavior
            function adjustLayout() {
                const mainContent = document.getElementById('mainContent');
                if (window.innerWidth < 992) {
                    mainContent.style.marginLeft = '0';
                } else {
                    mainContent.style.marginLeft = '240px';
                }
            }
            
            // Setup sidebar toggle for mobile
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            const backdrop = document.getElementById('sidebarBackdrop');
            if (backdrop) {
                backdrop.addEventListener('click', toggleSidebar);
            }
            
            // Make sidebar links close the sidebar on mobile
            document.querySelectorAll('.sidebar .nav-link:not(#settingsLink)').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 992) {
                        toggleSidebar();
                    }
                });
            });
            
            // Handle window resizing
            window.addEventListener('resize', adjustLayout);
            adjustLayout(); // Initial call
            
            checkAuthentication();
            loadPatients();
        });
    </script>
</body>
</html>